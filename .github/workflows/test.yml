name: Integration Test

on:
  workflow_dispatch:

jobs:
  test:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ["3.11"]

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: pip install -r requirements.txt pytest

      - name: Run unit tests
        run: pytest tests/ -v

      # ---- Build ----
      - name: Build executable (Windows)
        if: runner.os == 'Windows'
        shell: cmd
        run: |
          pip install pywin32
          pyinstaller --onefile ^
            --add-data "templates;templates" ^
            --name fkftp ^
            --hidden-import pyasyncore ^
            --hidden-import pyasynchat ^
            --hidden-import pyftpdlib.handlers ^
            --hidden-import pyftpdlib.filesystems ^
            --hidden-import pyftpdlib.authorizers ^
            --hidden-import win32serviceutil ^
            --hidden-import win32service ^
            --hidden-import win32event ^
            --hidden-import servicemanager ^
            --hidden-import win32api ^
            --console ^
            app.py

      - name: Build executable (macOS / Linux)
        if: runner.os != 'Windows'
        run: |
          pyinstaller --onefile \
            --add-data "templates:templates" \
            --name fkftp \
            --hidden-import pyasyncore \
            --hidden-import pyasynchat \
            --hidden-import pyftpdlib.handlers \
            --hidden-import pyftpdlib.filesystems \
            --hidden-import pyftpdlib.authorizers \
            --console \
            app.py

      - name: Verify build output exists
        shell: bash
        run: |
          if [ "$RUNNER_OS" = "Windows" ]; then
            test -f dist/fkftp.exe && echo "Build OK: dist/fkftp.exe"
          else
            test -f dist/fkftp && echo "Build OK: dist/fkftp"
          fi

      # ---- Integration tests with the built executable ----
      - name: Prepare test config
        shell: python
        run: |
          import json, hashlib, os
          salt = "testsalt12345678"
          pw_hash = hashlib.sha256((salt + "testpass").encode()).hexdigest()
          test_dir = os.path.join(os.getcwd(), "ftp_test_root")
          os.makedirs(test_dir, exist_ok=True)
          # Create a test file for download testing
          with open(os.path.join(test_dir, "hello.txt"), "w") as f:
              f.write("hello from fkftp")
          config = {
              "host": "127.0.0.1",
              "port": 2121,
              "passive_ports": [60000, 60100],
              "max_connections": 10,
              "max_connections_per_ip": 5,
              "banner": "CI Test Server",
              "web_port": 8080,
              "auto_start": True,
              "users": [
                  {
                      "username": "ci",
                      "password_hash": f"{salt}${pw_hash}",
                      "permissions": "elradfmw",
                      "directories": {"root": test_dir},
                  }
              ],
          }
          with open("dist/config.json", "w") as f:
              json.dump(config, f, indent=2)

      - name: Start server (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          cd dist
          ./fkftp.exe &
          sleep 5

      - name: Start server (macOS / Linux)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          cd dist
          chmod +x fkftp
          ./fkftp &
          sleep 5

      - name: Test Web UI is accessible
        shell: bash
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:8080/)
          echo "Web UI HTTP status: $STATUS"
          [ "$STATUS" = "200" ]

      - name: Test API - get config
        shell: bash
        run: |
          RESP=$(curl -s http://127.0.0.1:8080/api/config)
          echo "Config response: $RESP"
          echo "$RESP" | python -c "import sys,json; d=json.load(sys.stdin); assert d['port']==2121; assert d['users'][0]['username']=='ci'"

      - name: Test API - server status (auto-started)
        shell: bash
        run: |
          RESP=$(curl -s http://127.0.0.1:8080/api/server/status)
          echo "Server status: $RESP"
          echo "$RESP" | python -c "import sys,json; d=json.load(sys.stdin); assert d['running']==True"

      - name: Test API - platform info
        shell: bash
        run: |
          RESP=$(curl -s http://127.0.0.1:8080/api/platform)
          echo "Platform: $RESP"
          echo "$RESP" | python -c "import sys,json; d=json.load(sys.stdin); assert 'os' in d"

      - name: Test API - drives
        shell: bash
        run: |
          RESP=$(curl -s http://127.0.0.1:8080/api/drives)
          echo "Drives: $RESP"
          echo "$RESP" | python -c "import sys,json; d=json.load(sys.stdin); assert isinstance(d, list) and len(d)>0"

      - name: Test FTP - list files
        shell: python
        run: |
          import ftplib
          ftp = ftplib.FTP()
          ftp.connect("127.0.0.1", 2121)
          ftp.login("ci", "testpass")
          print("Login OK, banner:", ftp.getwelcome())
          files = ftp.nlst()
          print("Root listing:", files)
          assert "root" in files, f"Expected 'root' in {files}"
          ftp.cwd("root")
          files = ftp.nlst()
          print("root/ listing:", files)
          assert "hello.txt" in files, f"Expected 'hello.txt' in {files}"
          ftp.quit()
          print("FTP list test passed")

      - name: Test FTP - download file
        shell: python
        run: |
          import ftplib, io
          ftp = ftplib.FTP()
          ftp.connect("127.0.0.1", 2121)
          ftp.login("ci", "testpass")
          buf = io.BytesIO()
          ftp.retrbinary("RETR /root/hello.txt", buf.write)
          content = buf.getvalue().decode()
          print("Downloaded content:", repr(content))
          assert content == "hello from fkftp", f"Unexpected: {content!r}"
          ftp.quit()
          print("FTP download test passed")

      - name: Test FTP - upload file
        shell: python
        run: |
          import ftplib, io
          ftp = ftplib.FTP()
          ftp.connect("127.0.0.1", 2121)
          ftp.login("ci", "testpass")
          data = io.BytesIO(b"uploaded by CI")
          ftp.storbinary("STOR /root/uploaded.txt", data)
          files = ftp.nlst("/root")
          print("After upload:", files)
          assert "uploaded.txt" in files, f"Expected 'uploaded.txt' in {files}"
          # Verify content
          buf = io.BytesIO()
          ftp.retrbinary("RETR /root/uploaded.txt", buf.write)
          assert buf.getvalue() == b"uploaded by CI"
          ftp.quit()
          print("FTP upload test passed")

      - name: Test FTP - mkdir and rename
        shell: python
        run: |
          import ftplib
          ftp = ftplib.FTP()
          ftp.connect("127.0.0.1", 2121)
          ftp.login("ci", "testpass")
          ftp.mkd("/root/testdir")
          dirs = ftp.nlst("/root")
          print("After mkdir:", dirs)
          assert "testdir" in dirs
          ftp.rename("/root/testdir", "/root/renamed_dir")
          dirs = ftp.nlst("/root")
          print("After rename:", dirs)
          assert "renamed_dir" in dirs
          assert "testdir" not in dirs
          ftp.rmd("/root/renamed_dir")
          ftp.quit()
          print("FTP mkdir/rename test passed")

      - name: Test FTP - delete file
        shell: python
        run: |
          import ftplib
          ftp = ftplib.FTP()
          ftp.connect("127.0.0.1", 2121)
          ftp.login("ci", "testpass")
          ftp.delete("/root/uploaded.txt")
          files = ftp.nlst("/root")
          print("After delete:", files)
          assert "uploaded.txt" not in files
          ftp.quit()
          print("FTP delete test passed")

      - name: Test API - stop server
        shell: bash
        run: |
          RESP=$(curl -s -X POST http://127.0.0.1:8080/api/server/stop)
          echo "Stop response: $RESP"
          echo "$RESP" | python -c "import sys,json; d=json.load(sys.stdin); assert d['status']=='ok'"

      - name: Test API - restart server
        shell: bash
        run: |
          RESP=$(curl -s -X POST http://127.0.0.1:8080/api/server/start)
          echo "Start response: $RESP"
          echo "$RESP" | python -c "import sys,json; d=json.load(sys.stdin); assert d['status']=='ok'"
          # Verify it's running
          sleep 2
          RESP=$(curl -s http://127.0.0.1:8080/api/server/status)
          echo "Status after restart: $RESP"
          echo "$RESP" | python -c "import sys,json; d=json.load(sys.stdin); assert d['running']==True"

      - name: Test API - save config
        shell: bash
        run: |
          RESP=$(curl -s -X POST http://127.0.0.1:8080/api/config \
            -H "Content-Type: application/json" \
            -d '{"host":"127.0.0.1","port":2121,"passive_ports":[60000,60100],"max_connections":10,"max_connections_per_ip":5,"banner":"Updated","web_port":8080,"auto_start":false,"users":[{"username":"ci","permissions":"elradfmw","directories":{"root":"ftp_test_root"}}]}')
          echo "Save config response: $RESP"
          echo "$RESP" | python -c "import sys,json; d=json.load(sys.stdin); assert d['status']=='ok'"

      # ---- Upload artifact ----
      - name: Upload executable
        uses: actions/upload-artifact@v4
        with:
          name: fkftp-${{ matrix.os }}
          path: |
            dist/fkftp
            dist/fkftp.exe
          if-no-files-found: error
